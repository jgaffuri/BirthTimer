<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Birthtimer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    .section {
      margin-bottom: 20px;
    }

    button {
      margin-right: 10px;
      padding: 8px 12px;
    }

    ul {
      list-style-type: none;
      padding: 0;
    }

    li {
      margin-bottom: 5px;
    }
  </style>
</head>

<body>

  <h1 id="title"></h1>

  <div class="section">
    <label id="birthdateLabel"><input type="date" id="dateInput"></label>
    <label id="atLabel"><input type="time" id="timeInput"></label>
  </div>

  <div class="section">
    <h3 id="myAge"></h3>
    <ul id="durationList"></ul>
  </div>

  <div class="section">
    <h3 id="myNextMilestones"></h3>
    <div class="section" id="filters"></div>
    <ul id="milestoneList"></ul>

    <button id="downloadICS"></button>
    <button id="share-facebook"></button>
    <button id="share-whatsapp"></button>
    <button id="share-linkedin"></button>
    <button id="share-twitter"></button>
  </div>

  <div id="icsDialog"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:300px; text-align:center;">
      <h3 id="icsDialogTitle"></h3>
      <input type="text" id="personNameInput" value="Moi" style="margin:10px 0; width:90%; padding:5px;">
      <br>
      <button id="validateBtn"></button>
      <button id="cancelBtn"></button>
    </div>
  </div>

  <script>

    function getURLParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const supportedLangs = ["en", "fr", "de"];
    const paramLang = getURLParam("lang")
    const locale = getURLParam("locale") || navigator.language || navigator.userLanguage || "en-IE"
    const userLang = locale.substr(0, 2);
    let lang = supportedLangs.includes(paramLang) ? paramLang : supportedLangs.includes(userLang) ? userLang : "en";
    let t = {};

    fetch('lang.json')
      .then(response => response.json())
      .then(json => {
        t = json[lang];
        applyTranslations();
        initPage();
      });

    function applyTranslations() {
      document.getElementById('title').innerText = t.title;
      document.getElementById('birthdateLabel').childNodes[0].textContent = t.birthdateLabel + " ";
      document.getElementById('atLabel').childNodes[0].textContent = t.atLabel + " ";
      document.getElementById('myAge').innerText = t.myAge;
      document.getElementById('myNextMilestones').innerText = t.myNextMilestones;
      document.getElementById('downloadICS').innerText = t.addToCalendar;
      document.getElementById('share-facebook').innerText = t.shareFacebook;
      document.getElementById('share-whatsapp').innerText = t.shareWhatsapp;
      document.getElementById('share-linkedin').innerText = t.shareLinkedin;
      document.getElementById('share-twitter').innerText = t.shareTwitter;
      document.getElementById('icsDialogTitle').innerText = t.icsDialogTitle;
      document.getElementById('validateBtn').innerText = t.validate;
      document.getElementById('cancelBtn').innerText = t.cancel;

      // Filtres
      document.getElementById('filters').innerHTML = `
        <label><input type="checkbox" class="filterUnit" value="années">${t.filterYears}</label>
        <label><input type="checkbox" class="filterUnit" value="mois" checked>${t.filterMonths}</label>
        <label><input type="checkbox" class="filterUnit" value="jours" checked>${t.filterDays}</label>
        <label><input type="checkbox" class="filterUnit" value="heures" checked>${t.filterHours}</label>
        <label><input type="checkbox" class="filterUnit" value="minutes" checked>${t.filterMinutes}</label>
        <label><input type="checkbox" class="filterUnit" value="secondes" checked>${t.filterSeconds}</label>
      `;
    }


    function updateURLParam(name, value) {
      const params = new URLSearchParams(window.location.search);
      params.set(name, value);
      const newUrl = `${window.location.pathname}?${params.toString()}`;
      window.history.replaceState({}, '', newUrl);
    }




    function initPage() {

      let milestonesCache = [];
      let timerInterval;

      function setDefaultDateTime() {
        const dateInput = document.getElementById('dateInput');
        const timeInput = document.getElementById('timeInput');
        let startParam = getURLParam('start');
        let start;

        if (startParam) {
          start = new Date(startParam);
          if (isNaN(start)) start = null;
        }

        if (!start) {
          start = new Date();
          start.setFullYear(start.getFullYear() - 30);
          const iso = start.toISOString();
          updateURLParam('start', iso);
        }

        const yyyy = start.getFullYear();
        const mm = String(start.getMonth() + 1).padStart(2, '0');
        const dd = String(start.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;

        const hh = String(start.getHours()).padStart(2, '0');
        const min = String(start.getMinutes()).padStart(2, '0');
        const ss = String(start.getSeconds()).padStart(2, '0');
        timeInput.value = `${hh}:${min}:${ss}`;
      }

      function updateDurations() {
        const dateInputVal = document.getElementById('dateInput').value;
        const timeInputVal = document.getElementById('timeInput').value;
        if (!dateInputVal || !timeInputVal) return;

        const start = new Date(`${dateInputVal}T${timeInputVal}`);
        const now = new Date();
        const durationMs = now - start;
        if (durationMs <= 0) return;

        const seconds = Math.floor(durationMs / 1000);
        const minutes = Math.floor(durationMs / 60000);
        const hours = Math.floor(durationMs / 3600000);
        const days = Math.floor(durationMs / 86400000);
        const months = Math.floor(days / 30.44);
        const years = Math.floor(months / 12);

        const list = document.getElementById('durationList');
        list.innerHTML = `
    <li>${years.toLocaleString(locale)} ${t.years}</li>
    <li>${months.toLocaleString(locale)} ${t.months}</li>
    <li>${days.toLocaleString(locale)} ${t.days}</li>
    <li>${hours.toLocaleString(locale)} ${t.hours}</li>
    <li>${minutes.toLocaleString(locale)} ${t.minutes}</li>
    <li>${seconds.toLocaleString(locale)} ${t.seconds}</li>
  `;
      }

      function startTimer() {
        clearInterval(timerInterval);
        updateDurations();
        timerInterval = setInterval(updateDurations, 1000);
      }

      function isPowerOf10(n) {
        return (Math.log10(n) % 1 === 0);
      }


      function generateMilestones() {
        const dateInputVal = document.getElementById('dateInput').value;
        const timeInputVal = document.getElementById('timeInput').value;
        if (!dateInputVal || !timeInputVal) return;

        const start = new Date(`${dateInputVal}T${timeInputVal}`);
        const maxYears = 100;
        const maxMs = maxYears * 365.25 * 86400000;
        const now = new Date();
        const units = [
          { name: t.seconds, factor: 1000 },
          { name: t.minutes, factor: 60000 },
          { name: t.hours, factor: 3600000 },
          { name: t.days, factor: 86400000 },
          { name: t.months, factor: 30.44 * 86400000 },
          { name: t.years, factor: 365.25 * 86400000 }
        ];

        let milestones = [];

        units.forEach(u => {
          for (let exp = 0; exp <= 11; exp++) {
            for (let m = 1; m < 10; m++) {
              const value = m * Math.pow(10, exp);
              const durationMs = value * u.factor;
              if (durationMs > maxMs) break;
              const milestoneDate = new Date(start.getTime() + durationMs);
              if (milestoneDate > now)
                milestones.push({ value, unit: u.name, date: milestoneDate, durationMs });
            }
          }
        });

        milestones.sort((a, b) => a.durationMs - b.durationMs);
        milestonesCache = milestones;

        // Récupère les unités sélectionnées
        const selectedUnits = Array.from(document.querySelectorAll('.filterUnit:checked'))
          .map(cb => cb.value);

        const list = document.getElementById('milestoneList');
        list.innerHTML = "";
        milestones.forEach(m => {
          if (!selectedUnits.includes(m.unit)) return;
          const isPow10 = isPowerOf10(m.value);
          const date_ = m.date.toLocaleDateString(locale);
          const time_ = m.date.toLocaleTimeString(locale);
          list.innerHTML += `<li>Le ${date_} ${t.atLabel} ${time_}: ${isPow10 ? '<b>' : ''}${m.value.toLocaleString(locale)} ${m.unit}${isPow10 ? '</b>' : ''}</li>`;
        });
      }



      function downloadICS() {
        // Affiche la boîte de dialogue
        document.getElementById('icsDialog').style.display = 'flex';
      }

      function cancelICSDialog() {
        document.getElementById('icsDialog').style.display = 'none';
      }

      function validateICSDialog() {
        const personName = document.getElementById('personNameInput').value.trim() || "Moi";
        document.getElementById('icsDialog').style.display = 'none';

        const selectedUnits = Array.from(document.querySelectorAll('.filterUnit:checked'))
          .map(cb => cb.value);

        let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Durées//EN\n";
        milestonesCache.forEach(m => {
          if (!selectedUnits.includes(m.unit)) return;
          const dateStr = m.date.toLocaleDateString(locale);
          const timeStr = m.date.toLocaleTimeString(locale);
          const summary = `${m.value.toLocaleString(locale)} ${m.unit} de ${personName} le ${dateStr} à ${timeStr}`;
          ics += `BEGIN:VEVENT\nSUMMARY:${summary}\nDTSTART:${formatICSDate(m.date)}\nDTEND:${formatICSDate(new Date(m.date.getTime() + 3600000))}\nEND:VEVENT\n`;
        });
        ics += "END:VCALENDAR";

        const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "bx_" + simplifyString(personName) + ".ics";
        link.click();
      }

      function formatICSDate(d) {
        return d.toISOString().replace(/[-:]/g, '').split('.')[0] + "Z";
      }

      function simplifyString(str) {
        return str
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-zA-Z0-9\s]/g, "")
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "_");
      }


      function onDateTimeChange() {
        const dateInputVal = document.getElementById('dateInput').value;
        const timeInputVal = document.getElementById('timeInput').value;
        if (!dateInputVal || !timeInputVal) return;

        const isoDate = new Date(`${dateInputVal}T${timeInputVal}`).toISOString();
        updateURLParam('start', isoDate);

        startTimer();
        generateMilestones();
      }


      const ahahahURL = "https://www.ahahah.eu/birthtimer/"
      function getShareContent() {
        return {
          url: encodeURIComponent(ahahahURL + window.location.search),
          message: encodeURIComponent("Voici la liste de mes prochains x-iversaires ! N'oubliez pas de me les souhaiter :-)"),
          title: encodeURIComponent("Joyeux x-iversaire!"),
        }
      }

      // Ajout des événements click sur les boutons
      document.getElementById('share-facebook').addEventListener('click', function () {
        const c = getShareContent()
        var facebookUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + c.url + '&quote=' + c.message;
        window.open(facebookUrl, 'facebook-share-dialog', 'width=800,height=600');
      });

      document.getElementById('share-whatsapp').addEventListener('click', function () {
        const c = getShareContent()
        var whatsappUrl = "https://api.whatsapp.com/send?text=" + c.message + "%20" + c.url
        window.open(whatsappUrl, 'whatsapp-share-dialog', 'width=800,height=600');
      });

      document.getElementById('share-twitter').addEventListener('click', function () {
        const c = getShareContent()
        const twitterUrl = `https://twitter.com/intent/tweet?text=${c.message}&url=${c.url}`;
        window.open(twitterUrl, 'twitter-share-dialog', 'width=800,height=600');
      });

      document.getElementById('share-linkedin').addEventListener('click', function () {
        const c = getShareContent()
        //const linkedInUrl = `https://www.linkedin.com/sharing/share?url=${c.url}&title=${c.title}&summary=${c.message}&source=BirthTimer`
        const linkedInUrl = `https://www.linkedin.com/shareArticle?mini=true&url=${c.url}&title=${c.message}`;
        window.open(linkedInUrl, 'linkedin-share-dialog', 'width=800,height=600');
      });

      document.getElementById('dateInput').addEventListener('change', onDateTimeChange);
      document.getElementById('timeInput').addEventListener('change', onDateTimeChange);

      document.querySelectorAll('.filterUnit').forEach(cb => { cb.addEventListener('change', generateMilestones); });

      //window.onload = () => {
      setDefaultDateTime();
      startTimer();
      generateMilestones();
      //};
    }

  </script>

</body>

</html>